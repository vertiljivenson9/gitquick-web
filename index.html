<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ZIP ‚Üí GitHub Repo (Tree API)</title>
</head>
<body>

<h3>Subir ZIP a repositorio GitHub existente</h3>

<input type="text" id="owner" placeholder="owner (ej: vertiljivenson9)"><br><br>
<input type="text" id="repo" placeholder="repo (ej: Shark-os)"><br><br>
<input type="text" id="branch" value="main" placeholder="branch"><br><br>
<input type="password" id="token" placeholder="GitHub Token"><br><br>
<input type="file" id="zip" accept=".zip"><br><br>
<button onclick="upload()">Subir proyecto</button>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
async function upload() {
  const owner = ownerInput.value.trim();
  const repo = repoInput.value.trim();
  const branch = branchInput.value.trim();
  const token = tokenInput.value.trim();
  const zipFile = zipInput.files[0];

  if (!zipFile) return alert("Selecciona un ZIP");

  const headers = {
    "Authorization": "token " + token,
    "Accept": "application/vnd.github+json"
  };

  // 1Ô∏è‚É£ Obtener SHA del √∫ltimo commit
  const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/ref/heads/${branch}`, { headers });
  const refData = await refRes.json();
  const baseCommitSha = refData.object.sha;

  const commitRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/commits/${baseCommitSha}`, { headers });
  const commitData = await commitRes.json();
  const baseTreeSha = commitData.tree.sha;

  // 2Ô∏è‚É£ Leer ZIP
  const zip = await JSZip.loadAsync(zipFile);
  const tree = [];

  for (const path in zip.files) {
    const file = zip.files[path];
    if (file.dir) continue;

    const content = await file.async("base64");

    // 3Ô∏è‚É£ Crear blob
    const blobRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/blobs`, {
      method: "POST",
      headers,
      body: JSON.stringify({
        content,
        encoding: "base64"
      })
    });

    const blobData = await blobRes.json();

    tree.push({
      path,
      mode: "100644",
      type: "blob",
      sha: blobData.sha
    });
  }

  // 4Ô∏è‚É£ Crear TREE
  const treeRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees`, {
    method: "POST",
    headers,
    body: JSON.stringify({
      base_tree: baseTreeSha,
      tree
    })
  });

  const treeData = await treeRes.json();

  // 5Ô∏è‚É£ Crear commit
  const newCommitRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/commits`, {
    method: "POST",
    headers,
    body: JSON.stringify({
      message: "Upload project from mobile (Tree API)",
      tree: treeData.sha,
      parents: [baseCommitSha]
    })
  });

  const newCommit = await newCommitRes.json();

  // 6Ô∏è‚É£ Actualizar rama
  await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${branch}`, {
    method: "PATCH",
    headers,
    body: JSON.stringify({
      sha: newCommit.sha
    })
  });

  alert("Proyecto subido correctamente üöÄ");
}

const ownerInput = document.getElementById("owner");
const repoInput = document.getElementById("repo");
const branchInput = document.getElementById("branch");
const tokenInput = document.getElementById("token");
const zipInput = document.getElementById("zip");
</script>

</body>
</html>
