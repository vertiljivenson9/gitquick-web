<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ZIP → Shark-os</title>
</head>
<body>

<h3>Subir ZIP a Shark-os (GitHub)</h3>

<input id="token" placeholder="GitHub Token"><br><br>
<input id="zip" type="file" accept=".zip"><br><br>
<button onclick="upload()">SUBIR</button>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const OWNER = "vertiljivenson9";
const REPO  = "Shark-os";
const BRANCH = "main";

async function upload() {
  try {
    const token = document.getElementById("token").value.trim();
    const zipFile = document.getElementById("zip").files[0];

    if (!token || !zipFile) {
      alert("Falta token o ZIP");
      return;
    }

    const headers = {
      "Authorization": "token " + token,
      "Accept": "application/vnd.github+json",
      "User-Agent": "Shark-OS-Mobile-Uploader"
    };

    // 1️⃣ Obtener referencia
    let r = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/git/ref/heads/${BRANCH}`,
      { headers }
    );
    if (!r.ok) throw await r.text();
    const ref = await r.json();

    // 2️⃣ Obtener commit base
    r = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/git/commits/${ref.object.sha}`,
      { headers }
    );
    if (!r.ok) throw await r.text();
    const commit = await r.json();

    // 3️⃣ Leer ZIP
    const zip = await JSZip.loadAsync(zipFile);
    const tree = [];

    for (const path in zip.files) {
      const file = zip.files[path];
      if (file.dir) continue;

      const content = await file.async("base64");

      r = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/git/blobs`,
        {
          method: "POST",
          headers,
          body: JSON.stringify({ content, encoding: "base64" })
        }
      );
      if (!r.ok) throw await r.text();
      const blob = await r.json();

      tree.push({
        path,
        mode: "100644",
        type: "blob",
        sha: blob.sha
      });
    }

    // 4️⃣ Crear tree
    r = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/git/trees`,
      {
        method: "POST",
        headers,
        body: JSON.stringify({
          base_tree: commit.tree.sha,
          tree
        })
      }
    );
    if (!r.ok) throw await r.text();
    const newTree = await r.json();

    // 5️⃣ Commit
    r = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/git/commits`,
      {
        method: "POST",
        headers,
        body: JSON.stringify({
          message: "Upload ZIP from mobile",
          tree: newTree.sha,
          parents: [ref.object.sha]
        })
      }
    );
    if (!r.ok) throw await r.text();
    const newCommit = await r.json();

    // 6️⃣ Mover rama
    r = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/git/refs/heads/${BRANCH}`,
      {
        method: "PATCH",
        headers,
        body: JSON.stringify({
          sha: newCommit.sha,
          force: true
        })
      }
    );
    if (!r.ok) throw await r.text();

    alert("✅ SUBIDO A Shark-os");

  } catch (e) {
    console.error(e);
    alert("❌ ERROR:\n" + e);
  }
}
</script>

</body>
</html>
